name: Deploy to Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. SSH 进服务器，拉代码，本地构建并启动
      - name: Deploy on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          command_timeout: 30m
          script: |
            set -e
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH || '/opt/fmhome' }}"

            # 拉取最新代码（兼容目录已存在但非 git 仓库的情况）
            mkdir -p ${DEPLOY_PATH}
            cd ${DEPLOY_PATH}
            if [ ! -d ".git" ]; then
              echo ">>> 初始化仓库..."
              git init
              git remote add origin https://github.com/findxme/fmHome.git
            else
              echo ">>> 更新代码..."
            fi
            git fetch origin main
            git reset --hard origin/main

            # 写入环境变量（用 printf 避免 heredoc 缩进问题）
            echo ">>> 写入 .env..."
            printf 'CLAUDE_API_KEY=%s\nCLAUDE_API_URL=%s\nNODE_ENV=production\nPORT=3001\n' \
              '${{ secrets.CLAUDE_API_KEY }}' \
              '${{ secrets.CLAUDE_API_URL }}' > .env

            # 停止旧容器
            echo ">>> 停止旧容器..."
            docker-compose down || true

            # 本地构建镜像并启动
            echo ">>> 构建镜像并启动..."
            docker-compose up --build -d

            # 清理旧镜像
            docker image prune -f

            # 验证
            echo ">>> 等待服务启动..."
            sleep 15
            docker-compose ps
            curl -sf http://localhost:3001/api/health \
              && echo "✅ 部署成功！" \
              || (echo "❌ 健康检查失败" && docker-compose logs --tail=50 && exit 1)
