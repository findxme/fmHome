name: Deploy to Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 将代码同步到服务器并构建
      - name: Sync code and build on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          command_timeout: 30m
          script: |
            set -e
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH || '/opt/fmhome' }}"
            mkdir -p ${DEPLOY_PATH}/repo

      # 3. 通过 rsync 传输代码到服务器
      - name: Sync code to server
        uses: burnett01/rsync-deployments@7.0.1
        with:
          switches: -avzr --delete --exclude='.git' --exclude='node_modules' --exclude='server/data' --exclude='server/*.db*'
          path: ./
          remote_path: ${{ secrets.DEPLOY_PATH || '/opt/fmhome' }}/repo/
          remote_host: ${{ secrets.SERVER_HOST }}
          remote_port: ${{ secrets.SERVER_PORT || '22' }}
          remote_user: ${{ secrets.SERVER_USERNAME }}
          remote_key: ${{ secrets.SERVER_SSH_KEY }}

      # 4. 在服务器上构建并启动
      - name: Build and start on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          command_timeout: 30m
          script: |
            set -e
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH || '/opt/fmhome' }}"

            echo ">>> 当前提交: $(cat ${DEPLOY_PATH}/repo/.git/COMMIT_EDITMSG 2>/dev/null || echo 'unknown')"

            # 停止旧容器
            echo ">>> 停止旧容器..."
            cd ${DEPLOY_PATH}
            docker-compose down || true

            # 重新构建镜像
            echo ">>> 构建 Docker 镜像..."
            docker build -t fmhome:latest ${DEPLOY_PATH}/repo

            # 启动新容器
            echo ">>> 启动容器..."
            docker-compose up -d

            # 清理旧镜像
            docker image prune -f

            # 等待并验证
            echo ">>> 等待服务启动..."
            sleep 10
            docker-compose ps
            curl -sf http://localhost:3001/api/health && echo "✅ 部署成功！健康检查通过" || (echo "❌ 健康检查失败" && docker-compose logs --tail=50 app && exit 1)
