name: Deploy to Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. SSH 进服务器，拉代码，本地构建并启动
      - name: Deploy on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          command_timeout: 30m
          script: |
            set -e
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH || '/opt/fmhome' }}"

            # 拉取最新代码
            if [ -d "${DEPLOY_PATH}/.git" ]; then
              echo ">>> 更新代码..."
              cd ${DEPLOY_PATH}
              git pull origin main
            else
              echo ">>> 首次克隆代码..."
              git clone https://github.com/findxme/fmHome.git ${DEPLOY_PATH}
              cd ${DEPLOY_PATH}
            fi

            # 写入环境变量文件
            echo ">>> 写入 .env 配置..."
            cat > ${DEPLOY_PATH}/.env << 'ENVEOF'
            CLAUDE_API_KEY=${{ secrets.CLAUDE_API_KEY }}
            CLAUDE_API_URL=${{ secrets.CLAUDE_API_URL }}
            NODE_ENV=production
            PORT=3001
            ENVEOF

            # 停止旧容器
            echo ">>> 停止旧容器..."
            cd ${DEPLOY_PATH}
            docker-compose down || true

            # 本地构建镜像并启动
            echo ">>> 构建镜像并启动..."
            docker-compose up --build -d

            # 清理构建缓存
            docker image prune -f

            # 等待并验证
            echo ">>> 等待服务启动..."
            sleep 15
            docker-compose ps
            curl -sf http://localhost:3001/api/health \
              && echo "✅ 部署成功！" \
              || (echo "❌ 健康检查失败" && docker-compose logs --tail=50 && exit 1)
